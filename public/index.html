<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Territorial â€” Online (With Effects)</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#0d1117;font-family:Tahoma,Arial,sans-serif}
canvas{display:block;touch-action:none}
#lobby{position:fixed;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0d1117,#111827,#1a2333);}
.card{background:rgba(6,10,18,0.9);backdrop-filter:blur(8px);padding:16px;border-radius:12px;width:360px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04);color:#e6eef8}
.card h1{margin:0 0 8px;font-size:18px;text-align:center}
#mainMenuBtn{position:fixed;right:12px;top:12px;z-index:2100;background:#2563eb;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
#onlineBtn{margin-top:8px;background:#06b6d4;padding:10px;border-radius:8px;color:#021025;font-weight:700;border:none;width:100%;cursor:pointer}
#onlinePanel{display:none;position:fixed;inset:0;z-index:2500;align-items:center;justify-content:center;background:rgba(5,8,12,0.6)}
#roomUI{width:420px}
#backOnline{position:fixed;right:16px;top:12px;z-index:2600;background:#111827;color:white;padding:8px 10px;border-radius:10px;cursor:pointer}
#ratioBar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(255,255,255,0.92);padding:10px 12px;border-radius:14px;display:flex;align-items:center;gap:12px;z-index:1800}
#ratioBar input{width:160px}
#legend{position:fixed;left:12px;top:12px;z-index:1800;color:white;display:flex;flex-direction:column;gap:6px}
.legend-item{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px}
#victoryOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:3000}
#victoryCard{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));backdrop-filter:blur(8px);padding:28px;border-radius:16px;text-align:center;color:white;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
</style>
</head>
<body>
<canvas id="game"></canvas>
<canvas id="lineLayer" style="position:fixed;inset:0;pointer-events:none;z-index:1700"></canvas>

<div id="ratioBar" aria-hidden="false">
Â  <span style="font-weight:700">Ø§Ù„Ù‚ÙˆØ§Øª:</span>
Â  <input id="ratioSlider" type="range" min="10" max="100" value="50">
Â  <span id="ratioValue">50%</span>
</div>

<div id="mainMenuBtn" role="button">âŸµ Ø±Ø¬ÙˆØ¹</div>
<button id="onlineBtn">Ø§ÙˆÙ†Ù„Ø§ÙŠÙ† (ØºØ±Ù)</button>

<!-- Online panel -->
<div id="onlinePanel">
  <div class="card" id="roomUI">
    <h1>Ø§ÙˆÙ†Ù„Ø§ÙŠÙ† â€” ØºØ±Ù Ø§Ù„Ù„Ø¹Ø¨</h1>
    <div style="display:flex;gap:8px">
      <input id="roomName" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="flex:1;padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff">
      <select id="roomMax">
        <option value="2">2 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
        <option value="3">3 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
        <option value="4" selected>4 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
      </select>
    </div>
    <div style="margin-top:8px">
      <button id="createRoom" class="green" style="width:100%">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
    </div>
    <hr style="margin:12px 0;border-color:#1f2937">
    <div>
      <input id="joinId" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…" style="width:100%;padding:8px;border-radius:8px;border:none;background:#0b1220;color:#fff">
      <button id="joinRoom" style="margin-top:8px;width:100%" class="green">Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©</button>
    </div>
    <div style="margin-top:10px;text-align:center;color:#9fb2c6;font-size:13px">Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰</div>
  </div>
</div>

<div id="legend" aria-hidden="true"></div>
<div id="victoryOverlay"><div id="victoryCard"><div class="crown">ğŸ‘‘</div><h1 id="victoryText"></h1><div id="victorName" style="font-size:20px;margin-top:6px"></div><button id="victoryToLobby" class="green">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‘ÙˆØ¨ÙŠ</button></div></div>

<script src="socket-client.js"></script>
<script>
// --- Minimal client rendering & local UI wiring ---
// We'll reuse much of the original rendering logic but rely on server state when online.
let grid = [];
let players = [];
let cam = { x:0, y:0, scale:1 };
let selected = null;
let needRender = true;
const HEX = 34;
const DEFEND_RADIUS = HEX * 3.2;

const gameCanvas = document.getElementById('game');
const lineCanvas = document.getElementById('lineLayer');
const ctx = gameCanvas.getContext('2d');
const lctx = lineCanvas.getContext('2d');
function resize(){ gameCanvas.width = lineCanvas.width = window.innerWidth; gameCanvas.height = lineCanvas.height = window.innerHeight; needRender=true; }
window.addEventListener('resize', resize); resize();

function worldToScreen(x,y){ return { x:(x + cam.x) * cam.scale + gameCanvas.width/2, y:(y + cam.y) * cam.scale + gameCanvas.height/2 }; }
function drawHex(cx,cy,r){ ctx.beginPath(); for(let i=0;i<6;i++){ const a=Math.PI/3*i + Math.PI/6; const x=cx+Math.cos(a)*r; const y=cy+Math.sin(a)*r; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.closePath(); }

function render(){
  if(!needRender) return;
  ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,gameCanvas.width,gameCanvas.height);
  ctx.fillStyle = '#0d1117'; ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);
  if(!grid||grid.length===0) return;
  for(let i=0;i<grid.length;i++){
    const c = grid[i]; const s = worldToScreen(c.x, c.y);
    drawHex(s.x, s.y, HEX * cam.scale); ctx.fillStyle = c.owner == null ? '#ffffff' : players[c.owner] ? players[c.owner].color : '#fff'; ctx.fill();
    ctx.fillStyle = '#000'; ctx.textAlign = 'center'; ctx.font = (14 * Math.max(0.7, cam.scale)) + 'px Tahoma'; ctx.fillText(c.troops, s.x, s.y + (5 * cam.scale));
  }
  for(const p of players){ if(p && p.capital != null && p.alive) drawCapital(p.capital); }
  needRender=false;
}
function drawCapital(cellIdx){ if(!grid[cellIdx]) return; const c = grid[cellIdx]; const s = worldToScreen(c.x, c.y); ctx.beginPath(); ctx.lineWidth = Math.max(2, 3 * cam.scale); ctx.strokeStyle = 'rgba(255,215,0,0.95)'; ctx.arc(s.x, s.y, HEX * cam.scale + 6 * cam.scale, 0, Math.PI*2); ctx.stroke(); ctx.fillStyle = 'rgba(255,215,0,0.95)'; ctx.font = (18 * Math.max(0.7, cam.scale)) + 'px Tahoma'; ctx.textAlign = 'center'; ctx.fillText('â˜…', s.x, s.y - (HEX * cam.scale + 4 * cam.scale)); }

requestAnimationFrame(function loop(){ render(); requestAnimationFrame(loop); });

// UI wiring for online panel
const onlineBtn = document.getElementById('onlineBtn');
const onlinePanel = document.getElementById('onlinePanel');
const createRoom = document.getElementById('createRoom');
const joinRoomBtn = document.getElementById('joinRoom');
const backOnline = document.getElementById('backOnline');
const roomName = document.getElementById('roomName');
const roomMax = document.getElementById('roomMax');
const joinId = document.getElementById('joinId');

onlineBtn.addEventListener('click', ()=>{ onlinePanel.style.display='flex'; });
// create room and join handled in socket-client.js via exposed API
createRoom.addEventListener('click', ()=>{
  window.socketClient && window.socketClient.createRoom({name:roomName.value||null, maxPlayers:parseInt(roomMax.value,10)||4});
});
joinRoomBtn.addEventListener('click', ()=>{
  if(joinId.value.trim()=='') return alert('Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©'); window.socketClient && window.socketClient.joinRoom({roomId:joinId.value.trim()});
});
// back button
const backBtn = document.createElement('div'); backBtn.id='backOnline'; backBtn.textContent='âŸµ Ø±Ø¬ÙˆØ¹'; backBtn.addEventListener('click', ()=>{ onlinePanel.style.display='none'; window.socketClient && window.socketClient.leaveRoom && window.socketClient.leaveRoom(); }); document.body.appendChild(backBtn);

// receive updates from socket client
function applyState(state){
  if(!state) return;
  grid = state.grid;
  players = state.players;
  needRender = true;
  // if client has player index, center camera on its capital when game starts
  if(window.socketClient && window.socketClient.playerId != null && players[window.socketClient.playerId] && players[window.socketClient.playerId].capital!=null){
    const c = grid[players[window.socketClient.playerId].capital];
    cam.x = -c.x; cam.y = -c.y; needRender=true;
  }
}

window.applyState = applyState;

// intercept clicks: when online, send move actions to server instead of local move
gameCanvas.addEventListener('click', e=>{
  const rect=gameCanvas.getBoundingClientRect();
  const pos = { x:(e.clientX - rect.left - gameCanvas.width/2)/cam.scale - cam.x, y:(e.clientY - rect.top - gameCanvas.height/2)/cam.scale - cam.y };
  // find nearest cell
  let best=null, bd=HEX*1.05; for(let i=0;i<grid.length;i++){ const d=Math.hypot(grid[i].x-pos.x, grid[i].y-pos.y); if(d<bd){ bd=d; best=i; } }
  if(best==null) return;
  if(selected==null){
    if(grid[best].owner=== (window.socketClient ? window.socketClient.playerId : 0)) selected=best;
  } else {
    if(best!==selected){
      // send move command if online
      if(window.socketClient && window.socketClient.mode==='online'){
        const ratio = (document.getElementById('ratioSlider').value|0)/100;
        window.socketClient.sendAction({type:'move', from:selected, to:best, ratio});
      } else {
        // offline action left as-is (not implemented here - online mode focuses)
      }
    }
    selected=null;
  }
});

</script>
</body>
</html>
