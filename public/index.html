<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Territorial â€” Final</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#070606;font-family:Tahoma,Arial,sans-serif;color:#e6e6e6}
canvas{display:block;touch-action:none}
/* LUXURY BLACK-GOLD THEME */
#lobby{position:fixed;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#050405,#0b0a0a);animation:bgMove 8s infinite alternate}
@keyframes bgMove{0%{filter:brightness(1)}100%{filter:brightness(1.06)}}
.card{background:linear-gradient(180deg,rgba(255,215,80,0.03),rgba(255,215,80,0.01));border:1px solid rgba(255,215,80,0.06);padding:22px;border-radius:14px;width:420px;box-shadow:0 14px 50px rgba(0,0,0,0.6)}
.card h1{margin:0 0 12px;font-size:20px;text-align:center;color:#ffd96b}
label{display:block;color:#d9c98a;margin-top:8px;font-weight:700}
select,input[type=range],input[type=text]{width:100%;margin:8px 0;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.45);color:#fff}
button{padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.green{background:#ffd54a;color:#070606}
.blue{background:#06b6d4;color:#042022}
.small{padding:8px;font-size:13px}
#ratioBar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(255,255,255,0.06);padding:10px 12px;border-radius:14px;display:flex;align-items:center;gap:12px;z-index:1800;color:#fff}
#legend{position:fixed;left:12px;top:12px;z-index:1800;color:white;display:flex;flex-direction:column;gap:6px}
.legend-item{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px}
#dbg{position:fixed;right:8px;bottom:8px;z-index:2200;background:rgba(0,0,0,0.7);color:#fff;padding:8px;border-radius:8px;font-size:12px;display:none;max-width:40vw}
#mainMenuBtn{position:fixed;right:12px;top:12px;z-index:2100;background:#111827;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
#onlinePage{display:none}
#settingsPanel{display:none;background:rgba(255,215,80,0.04);border:1px solid rgba(255,215,80,0.06);padding:12px;border-radius:12px;margin-top:8px}
#pingDisplay{position:fixed;right:12px;top:64px;background:rgba(0,0,0,0.6);color:#ffd54a;padding:6px 8px;border-radius:8px;font-weight:700;z-index:4000;display:none}
#leaveRoomBtn{background:#ff6b6b;color:#fff;border-radius:8px;padding:8px 10px;border:none;cursor:pointer}
.fade-in { animation: fadeIn 650ms ease both; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0)} }
</style>
</head>
<body>

<canvas id="game"></canvas>
<canvas id="lineLayer" style="position:fixed;inset:0;pointer-events:none;z-index:1700"></canvas>

<div id="ratioBar" aria-hidden="false" class="fade-in">
Â  <span style="font-weight:700">Ø§Ù„Ù‚ÙˆØ§Øª:</span>
Â  <input id="ratioSlider" type="range" min="10" max="100" value="50">
Â  <span id="ratioValue">50%</span>
</div>

<div id="mainMenuBtn" role="button">âŸµ Ø±Ø¬ÙˆØ¹</div>

<div id="lobby" role="dialog" aria-label="Lobby">
Â  <div class="card fade-in">
Â  Â  <h1>Ù„ÙˆØ¨ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© â€” Ø§Ù„Ø£Ø³ÙˆØ¯ Ã— Ø§Ù„Ø°Ù‡Ø¨ÙŠ</h1>

Â  Â  <label>Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</label>
Â  Â  <input id="playerName" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ..." autocomplete="off">

Â  Â  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</label>
Â  Â  <select id="playerCount">
Â  Â  Â  <option value="2">2</option>
Â  Â  Â  <option value="3">3</option>
Â  Â  Â  <option value="4" selected>4</option>
Â  Â  </select>

Â  Â  <label>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)</label>
Â  Â  <input id="prodRate" type="range" min="300" max="2000" value="900">

Â  Â  <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
Â  Â  Â  <button id="startBtn" class="green" style="width:100%">Ø§Ø¨Ø¯Ø£ (Ø£ÙˆÙÙ„Ø§ÙŠÙ†)</button>
Â  Â  Â  <button id="onlineBtnLocal" class="blue" style="width:100%">Ø§ÙˆÙ†Ù„Ø§ÙŠÙ† (ØºØ±Ù)</button>
Â  Â  Â  <div id="settingsPanelToggle" style="display:flex;gap:8px;margin-top:6px">
Â  Â  Â  Â  <button id="settingsBtn" class="small" style="flex:1;background:#111;color:#ffd54a;border-radius:8px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="settingsPanel" aria-hidden="true">
Â  Â  Â  <label style="margin-top:6px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</label>
Â  Â  Â  <div style="display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  <span>Ø¹Ø±Ø¶ Ping</span>
Â  Â  Â  Â  <button id="togglePing" class="small" style="background:#ff6b6b;color:#fff;border-radius:8px">Ø¥ÙŠÙ‚Ø§Ù</button>
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
Â  Â  Â  Â  <span>Menu Debug (Console M)</span>
Â  Â  Â  Â  <button id="toggleDebug" class="small" style="background:#ff6b6b;color:#fff;border-radius:8px">Ø¥ÙŠÙ‚Ø§Ù</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<!-- FULLSCREEN ONLINE PAGE -->
<div id="onlinePage" style="display:none;position:fixed;inset:0;z-index:3000;background:linear-gradient(180deg,#050405,#081018);color:#e6eef8;overflow:auto;padding:36px 12px">
Â  <div style="max-width:840px;margin:0 auto">
Â  Â  <div style="display:flex;justify-content:flex-end;gap:8px">
Â  Â  Â  <button id="onlineBack" style="background:#111827;color:white;padding:8px 12px;border-radius:10px;cursor:pointer">Ø±Ø¬ÙˆØ¹ âŸµ</button>
Â  Â  Â  <button id="leaveRoomUI" style="display:none" class="small">Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±ÙØ©</button>
Â  Â  </div>
Â  Â  <h1 style="text-align:center;margin:18px 0;font-size:28px;color:#ffd54a">Ø§ÙˆÙ†Ù„Ø§ÙŠÙ† â€” Ù†Ø¸Ø§Ù… Ø§Ù„ØºØ±Ù</h1>
Â  Â  <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
Â  Â  Â  <div style="background:rgba(255,215,80,0.03);padding:18px;border-radius:12px">
Â  Â  Â  Â  <h2 style="margin:0 0 8px;color:#ffd54a">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h2>
Â  Â  Â  Â  <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</label>
Â  Â  Â  Â  <select id="roomMax" style="width:100%;padding:10px;border-radius:8px;border:none;background:#0b1220;color:#fff;margin-bottom:10px">
Â  Â  Â  Â  Â  <option value="2">2 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option><option value="3">3 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option><option value="4" selected>4 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  Â  <button id="createRoom" class="green" style="flex:1">Ø¥Ù†Ø´Ø§Ø¡</button>
Â  Â  Â  Â  Â  <button id="startRoom" class="green" style="flex:1;background:#ffd54a;color:#000">Ø¨Ø¯Ø¡ (Ù…Ø¶ÙŠÙ ÙÙ‚Ø·)</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="roomInfo" style="margin-top:10px;font-size:13px;color:#d0c68a"></div>
Â  Â  Â  </div>
Â  Â  Â  <div style="background:rgba(255,215,80,0.02);padding:18px;border-radius:12px">
Â  Â  Â  Â  <h2 style="margin:0 0 8px;color:#ffd54a">Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</h2>
Â  Â  Â  Â  <label>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</label>
Â  Â  Â  Â  <input id="joinCode" placeholder="Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©" style="width:100%;padding:10px;border-radius:8px;border:none;background:#0b1220;color:#fff;margin-bottom:8px">
Â  Â  Â  Â  <button id="joinRoom" class="green" style="width:100%">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  <h3 style="margin:0 0 6px;color:#ffd54a">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©</h3>
Â  Â  Â  Â  Â  <ul id="playerList" style="list-style:none;padding:0;margin:0;color:#fff"></ul>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div style="margin-top:18px;color:#d0c68a;font-size:13px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¸Ø§Ù… WebSocket. Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ØªÙƒÙˆÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…ØªØ²Ø§Ù…Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ø¨ÙˆØªØ§Øª.</div>
Â  </div>
</div>

<div id="legend" aria-hidden="true"></div>\n<div id="pingDisplay" style="position:fixed;left:12px;bottom:12px;z-index:4000;background:rgba(0,0,0,0.6);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;display:none">Ping: <span id="pingValue">0</span> ms</div>
<div id="dbg" role="status"></div>
<div id="pingDisplay">PING: <span id="pingValue">0</span> ms</div>

<script>
var grid = [];
</script>

<!-- Game logic (client) - trimmed/cleaned with online support -->
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  'use strict';
  const HEX = 34;
  const gameCanvas = document.getElementById('game');
  const lineCanvas = document.getElementById('lineLayer');
  const ratioSlider = document.getElementById('ratioSlider');
  const ratioValue = document.getElementById('ratioValue');
  const startBtn = document.getElementById('startBtn');
  const playerCount = document.getElementById('playerCount');
  const prodRate = document.getElementById('prodRate');
  const legendEl = document.getElementById('legend');
  const onlineBtnLocal = document.getElementById('onlineBtnLocal');
  const onlinePage = document.getElementById('onlinePage');
  const onlineBack = document.getElementById('onlineBack');
  const createRoomBtn = document.getElementById('createRoom');
  const joinRoomBtn = document.getElementById('joinRoom');
  const startRoomBtn = document.getElementById('startRoom');
  const roomInfo = document.getElementById('roomInfo');
  const playerList = document.getElementById('playerList');
  const joinCodeInput = document.getElementById('joinCode');
  const roomMaxSelect = document.getElementById('roomMax');
  const playerNameInput = document.getElementById('playerName');
  const leaveRoomUI = document.getElementById('leaveRoomUI');
  const leaveRoomBtn = document.getElementById('leaveRoomBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const togglePing = document.getElementById('togglePing');
  const toggleDebug = document.getElementById('toggleDebug');
  const pingDisplay = document.getElementById('pingDisplay');
  const pingValueEl = document.getElementById('pingValue');

  let showPing = false;
  let debugEnabled = false;
  let needRender = true;

  // simple ping hook from socket client
  window.onPing = function(ms){
    if(showPing){ pingValueEl.textContent = (ms===null? '--': String(ms)); pingDisplay.style.display='block'; }
  };

  settingsBtn && settingsBtn.addEventListener('click', ()=>{
    settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
  });
  togglePing && togglePing.addEventListener('click', ()=>{
    showPing = !showPing;
    togglePing.style.background = showPing? '#16a34a' : '#ff6b6b';
    if(!showPing) pingDisplay.style.display='none';
  });
  toggleDebug && toggleDebug.addEventListener('click', ()=>{
    debugEnabled = !debugEnabled;
    toggleDebug.style.background = debugEnabled? '#16a34a' : '#ff6b6b';
    document.getElementById('debugToggle').style.display = debugEnabled? 'block':'none';
  });

  // Debug logger
  window.debugLogs = [];
  function debugLog(msg){
    try{
      const pre = document.getElementById('consoleLog');
      const time = new Date().toLocaleTimeString();
      const line = '['+time+'] ' + (typeof msg === 'object' ? JSON.stringify(msg) : msg);
      window.debugLogs.push(line);
      if(pre){
        pre.textContent = window.debugLogs.slice(-500).join("\n") + "\n";
        pre.scrollTop = pre.scrollHeight;
      }
      if(debugEnabled) console.log('DEBUG:', msg);
    }catch(e){ console.log('debugLog failed', e); }
  }
  window._debugLog = debugLog;

  // canvas setup (kept simpler)
  const ctx = gameCanvas.getContext('2d');
  const lctx = lineCanvas.getContext('2d');
  let W=0, H=0;
  function resize(){ W = gameCanvas.width = window.innerWidth || 300; H = gameCanvas.height = window.innerHeight || 200; lineCanvas.width = W; lineCanvas.height = H; needRender=true; }
  window.addEventListener('resize', resize); resize();

  var players = [];
  var cam = { x:0, y:0, scale:1 };
  var selected = null;
  var animations = [];
  var effects = [];
  var prodTimer = null, botTimer = null;
  var dragging=false,lastX=0,lastY=0;

  function buildGrid(){
    grid.length=0;
    const cols = Math.max(8, Math.floor(W / (HEX * 1.6)));
    const rows = Math.max(6, Math.floor(H / (HEX * 1.25)));
    const startX = -cols * HEX * 0.85;
    const startY = -rows * HEX * 0.95;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const x = startX + c * HEX * 1.7 + (r % 2 ? HEX * 0.85 : 0);
        const y = startY + r * HEX * 1.45;
        grid.push({ x,y, owner:null, troops:0, neighbors:[] });
      }
    }
    for(let i=0;i<grid.length;i++){
      const a=grid[i];
      for(let j=0;j<grid.length;j++){
        if(i===j) continue;
        const b=grid[j];
        if(Math.hypot(a.x-b.x,a.y-b.y) < HEX * 1.75) a.neighbors.push(j);
      }
    }
    needRender=true;
  }

  function worldToScreen(x,y){ return { x:(x + cam.x) * cam.scale + W/2, y:(y + cam.y) * cam.scale + H/2 }; }
  function screenToWorld(sx,sy){ return { x:(sx - W/2) / cam.scale - cam.x, y:(sy - H/2) / cam.scale - cam.y }; }
  function drawHex(cx,cy,r){ ctx.beginPath(); for(let i=0;i<6;i++){ const a=Math.PI/3*i + Math.PI/6; const x=cx+Math.cos(a)*r; const y=cy+Math.sin(a)*r; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.closePath(); }
  function cellAt(wx,wy){ if(!grid||grid.length===0) return null; let best=null, bd=HEX*1.05; for(let i=0;i<grid.length;i++){ const d=Math.hypot(grid[i].x-wx, grid[i].y-wy); if(d<bd){ bd=d; best=i; } } return best; }
  function isNeighbor(a,b){ if(!grid||!grid[a]||!grid[b]) return false; return Math.hypot(grid[a].x-grid[b].x, grid[a].y-grid[b].y) < HEX * 1.8; }

  function setupPlayers(n){
    players=[];
    const used = new Set();
    const colorPool = ['#3399ff','#ff5555','#ffe047','#8a60ff','#00c48c','#ff8800','#33ffaa','#aa33ff','#ff33aa'];
    for(let i=0;i<n;i++){
      let color;
      do{ color = colorPool[Math.floor(Math.random()*colorPool.length)]; } while(used.has(color));
      used.add(color);
      players.push({ id:i, color:color, name:'P'+(i+1), capital:null, alive:true });
    }
    updateLegend();
    needRender=true;
  }

  function seedCapitals(){
    if(!grid || grid.length===0) buildGrid();
    grid.forEach(c=>{ c.owner=null; c.troops=0; });
    const xs = grid.map(c=>c.x), ys = grid.map(c=>c.y);
    const cxMin = Math.min(...xs), cxMax = Math.max(...xs);
    const cyMin = Math.min(...ys), cyMax = Math.max(...ys);
    const corners = [[cxMin,cyMin],[cxMax,cyMin],[cxMin,cyMax],[cxMax,cyMax]];
    // randomize assignment
    const order = corners.sort(()=>Math.random()-0.5);
    for(let p=0;p<players.length;p++){
      const pt = order[p % order.length];
      let bestIdx=0, bestD=Infinity;
      for(let i=0;i<grid.length;i++){ const d=Math.hypot(grid[i].x-pt[0], grid[i].y-pt[1]); if(d<bestD){ bestD=d; bestIdx=i; } }
      grid[bestIdx].owner = players[p].id;
      grid[bestIdx].troops = 40;
      players[p].capital = bestIdx;
    }
    needRender=true;
  }

  function startProduction(ms){ if(prodTimer) clearInterval(prodTimer); prodTimer = setInterval(()=>{ if(grid && grid.length) grid.forEach(c=>{ if(c.owner != null) c.troops++; }); }, Math.max(50, parseInt(ms,10) || 900)); }

  function animateMove(fromIdx,toIdx,color){ if(!grid||!grid[fromIdx]||!grid[toIdx]) return; animations.push({ fromIdx,toIdx,color,t:0 }); needRender=true; }
  function updateAnimations(delta){ lctx.clearRect(0,0,W,H); if(!grid||grid.length===0) return; const remaining=[]; for(const a of animations){ a.t += delta*0.004; if(a.t>=1) continue; const A = worldToScreen(grid[a.fromIdx].x, grid[a.fromIdx].y); const B = worldToScreen(grid[a.toIdx].x, grid[a.toIdx].y); const x = A.x + (B.x - A.x) * a.t; const y = A.y + (B.y - A.y) * a.t; lctx.beginPath(); lctx.fillStyle = a.color; lctx.arc(x,y,6*Math.max(0.6,cam.scale),0,Math.PI*2); lctx.fill(); remaining.push(a); } animations = remaining; if(animations.length>0) needRender=true; }

  function moveTroopsLocal(fromIdx,toIdx,ratio){
    if(!grid||!grid[fromIdx]||!grid[toIdx]) return;
    const f=grid[fromIdx], t=grid[toIdx];
    const send = Math.floor(f.troops * ratio);
    if(send<=0) return;
    f.troops = Math.max(0, f.troops - send);
    animateMove(fromIdx,toIdx, players[f.owner]?players[f.owner].color:'#fff');
    if(t.owner === f.owner){ t.troops += send; }
    else {
      if(send > t.troops){
        const defeatedOwner = t.owner;
        t.owner = f.owner;
        t.troops = send - t.troops;
        if(defeatedOwner != null){
          const defPlayer = players.find(p=>p.id===defeatedOwner);
          if(defPlayer && defPlayer.capital === toIdx){
            defPlayer.alive = false;
            for(const c of grid){ if(c.owner===defeatedOwner){ c.owner=null; c.troops=0; } }
          }
        }
      } else {
        t.troops = Math.max(0, t.troops - send);
      }
    }
    needRender=true;
  }

  function applyState(state){
    if(!state) return;
    if(state.grid && Array.isArray(state.grid)) window.grid = state.grid;
    if(state.players && Array.isArray(state.players)){
      players = state.players.map(p=>({ id:p.index, color:p.color || '#999', name:p.name || ('P'+(p.index+1)), capital:p.capital, alive:!!p.alive }));
    }
    updateLegend();
    needRender=true;
  }
  window.applyState = applyState;

  function requestRender(){ needRender=true; }

  function updateLegend(){ if(!legendEl) return; legendEl.innerHTML=''; for(const p of players){ const div=document.createElement('div'); div.className='legend-item'; div.innerHTML=`<div style="width:14px;height:10px;background:${p.color};border-radius:4px"></div><div style="font-size:13px">${p.name}</div>`; legendEl.appendChild(div);} }

  function render(){ if(!ctx) return; if(!needRender) return;
    ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,W,H); ctx.fillStyle='#070606'; ctx.fillRect(0,0,W,H); if(!grid||grid.length===0) return;
    for(let i=0;i<grid.length;i++){ const c=grid[i]; const s=worldToScreen(c.x,c.y); drawHex(s.x,s.y,HEX*cam.scale); ctx.fillStyle = (c.owner==null)?'#cfcfcf': (players[c.owner]?players[c.owner].color:'#fff'); ctx.fill(); ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.font=(14*Math.max(0.7,cam.scale))+'px Tahoma'; ctx.fillText(c.troops, s.x, s.y + (5*cam.scale)); }
    for(const p of players){ if(p && p.capital != null && p.alive){ const c = grid[p.capital]; if(c){ const s=worldToScreen(c.x,c.y); ctx.beginPath(); ctx.lineWidth = Math.max(2,3*cam.scale); ctx.strokeStyle='rgba(255,215,0,0.95)'; ctx.arc(s.x,s.y,HEX*cam.scale+6*cam.scale,0,Math.PI*2); ctx.stroke(); ctx.fillStyle='rgba(255,215,0,0.95)'; ctx.font=(18*Math.max(0.7,cam.scale))+'px Tahoma'; ctx.textAlign='center'; ctx.fillText('â˜…', s.x, s.y - (HEX*cam.scale + 4*cam.scale)); } } }
    needRender=false;
  }

  // Input handling: when online (roomId present) send action to server
  gameCanvas.addEventListener('click', e=>{
    const pos = screenToWorld(e.clientX, e.clientY); const idx = cellAt(pos.x,pos.y); if(idx==null) return;
    const cell = grid[idx];
    const meIndex = (window.socketClient && window.socketClient.getPlayerIndex) ? window.socketClient.getPlayerIndex() : null;
    const inRoom = (window.socketClient && window.socketClient.getRoomId && window.socketClient.getRoomId());
    if(selected === null){
      if(!inRoom){
        if(cell.owner === 0) selected = idx;
      } else {
        if(cell.owner === meIndex) selected = idx;
      }
    } else {
      if(idx !== selected && isNeighbor(selected, idx)){
        const ratio = ratioSlider ? parseInt(ratioSlider.value,10)/100 : 0.5;
        if(inRoom && window.socketClient && window.socketClient.sendAction){
          window.socketClient.sendAction({ type:'move', from:selected, to:idx, ratio });
        } else {
          moveTroopsLocal(selected, idx, ratio);
        }
      }
      selected = null;
    }
    requestRender();
  });

  // -- Starter / lobby controls --
  function startGameOffline(){ if(!grid || grid.length<8) buildGrid(); const cnt = Math.max(2, Math.min(4, parseInt(playerCount.value,10)||4)); setupPlayers(cnt); seedCapitals(); startProduction(prodRate?parseInt(prodRate.value,10):900); if(botTimer) clearInterval(botTimer); botTimer = setInterval(()=>{/* bots */},900); document.getElementById('lobby').style.display='none'; updateLegend(); needRender=true; }
  startBtn && startBtn.addEventListener('click', startGameOffline);
  onlineBtnLocal && onlineBtnLocal.addEventListener('click', ()=>{ document.getElementById('lobby').style.display='none'; onlinePage.style.display='block'; });

  onlineBack && onlineBack.addEventListener('click', ()=>{ onlinePage.style.display='none'; document.getElementById('lobby').style.display='flex'; });

  createRoomBtn && createRoomBtn.addEventListener('click', ()=>{
    const maxPlayers = parseInt(roomMaxSelect.value,10)||4;
    const name = (playerNameInput && playerNameInput.value) ? playerNameInput.value.trim() : null;
    if(window.socketClient && window.socketClient.createRoom){
      window.socketClient.createRoom({ name, maxPlayers });
    }
  });

  joinRoomBtn && joinRoomBtn.addEventListener('click', ()=>{
    const code = joinCodeInput.value.trim();
    const name = (playerNameInput && playerNameInput.value) ? playerNameInput.value.trim() : null;
    if(!code) return alert('Ø§Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©');
    if(window.socketClient && window.socketClient.joinRoom){
      window.socketClient.joinRoom({ roomId: code, name });
    }
  });

  startRoomBtn && startRoomBtn.addEventListener('click', ()=>{
    if(window.socketClient && window.socketClient.startGame){
      window.socketClient.startGame({ prodRate: parseInt(document.getElementById('prodRate').value,10) || 900 });
    }
  });

  window.updateRoomPlayers = function(playersArr){
    if(!playerList) return;
    playerList.innerHTML='';
    playersArr.forEach(p=>{ const li=document.createElement('li'); li.style.padding='6px 4px'; li.style.borderBottom='1px dashed rgba(255,255,255,0.02)'; li.innerHTML = `<span style="display:inline-block;width:12px;height:10px;background:${p.color||'#999'};margin-left:8px;border-radius:4px;"></span> ${(p.name||('P'+(p.index+1)))} ${p.isHost? ' <strong>ğŸ‘‘</strong>':''}`; playerList.appendChild(li); });
    leaveRoomUI.style.display = 'inline-block';
  };

  leaveRoomUI && leaveRoomUI.addEventListener('click', ()=>{
    if(window.socketClient && window.socketClient.leaveRoom){ window.socketClient.leaveRoom(); leaveRoomUI.style.display='none'; onlinePage.style.display='none'; document.getElementById('lobby').style.display='flex'; }
  });

  // initial scene
  buildGrid(); setupPlayers(4); seedCapitals(); updateLegend(); needRender=true;

  // rendering loop
  let last = performance.now();
  function frame(now){
    const dt = now - last; last = now;
    try{ updateAnimations(dt); updateEffects(dt); render(); }catch(e){ console.error(e); }
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  // helper to display ping on interval when enabled
  setInterval(()=>{ if(showPing && window.socketClient && window.socketClient.ping){ window.socketClient.ping((rtt)=>{ if(typeof rtt==='number'){ pingValueEl.textContent = rtt; pingDisplay.style.display='block'; } }); } }, 2000);

});
</script>

<!-- socket client inclusion -->
<script src="socket-client.js"></script>

<!-- debug console UI -->
<button id="debugToggle" title="Toggle Console (M)" style="position:fixed;left:12px;top:12px;z-index:4000;background:rgba(255,255,255,0.02);color:#ffd54a;border:none;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;display:none">M</button>
<div id="debugConsole" style="display:none;position:fixed;left:12px;top:56px;z-index:4000;width:360px;max-height:60vh;overflow:auto;background:rgba(2,6,23,0.9);border-radius:10px;padding:8px;color:#d1d5db;box-shadow:0 12px 40px rgba(0,0,0,0.6)">
Â  <div style="display:flex;justify-content:flex-end"><button id="closeConsole" style="background:transparent;border:none;color:#f87171;font-weight:700;cursor:pointer">X</button></div>
Â  <pre id="consoleLog" style="white-space:pre-wrap;font-size:12px;margin:0;height:60vh;overflow:auto"></pre>
</div>

<script>
document.getElementById('debugToggle').addEventListener('click', toggleConsole);
document.getElementById('closeConsole').addEventListener('click', toggleConsole);
function toggleConsole(){ const el=document.getElementById('debugConsole'); el.style.display = (el.style.display==='none'?'block':'none'); }
document.addEventListener('keydown', function(e){ if(e.key && e.key.toLowerCase()==='m' && document.getElementById('debugToggle').style.display!=='none'){ toggleConsole(); } });
</script>


// ===== Settings, Ping and Debug wiring (injected) =====
(function(){
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsModal = document.getElementById('settingsModal');
  const settingsClose = document.getElementById('settingsClose');
  const togglePing = document.getElementById('togglePing');
  const toggleDebug = document.getElementById('toggleDebug');
  const pingDisplay = document.getElementById('pingDisplay');
  const pingValue = document.getElementById('pingValue');

  // Load saved options or defaults
  const opts = {
    ping: localStorage.getItem('gw_ping') === '1',
    debug: localStorage.getItem('gw_debug') === '1'
  };

  function updateToggleButtons(){
    togglePing.textContent = opts.ping ? 'ØªØ´ØºÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù';
    togglePing.style.background = opts.ping ? '#16a34a' : '#ef4444';
    toggleDebug.textContent = opts.debug ? 'ØªØ´ØºÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù';
    toggleDebug.style.background = opts.debug ? '#16a34a' : '#ef4444';
    pingDisplay.style.display = opts.ping ? 'block' : 'none';
  }
  updateToggleButtons();

  if(settingsBtn) settingsBtn.addEventListener('click', ()=>{ settingsModal.style.display='flex'; });
  if(settingsClose) settingsClose.addEventListener('click', ()=>{ settingsModal.style.display='none'; });

  if(togglePing) togglePing.addEventListener('click', ()=>{
    opts.ping = !opts.ping;
    localStorage.setItem('gw_ping', opts.ping ? '1' : '0');
    updateToggleButtons();
    if(opts.ping){
      startPingLoop();
    } else {
      if(window._stopPingLoop) window._stopPingLoop();
    }
  });
  if(toggleDebug) toggleDebug.addEventListener('click', ()=>{
    opts.debug = !opts.debug;
    localStorage.setItem('gw_debug', opts.debug ? '1' : '0');
    updateToggleButtons();
  });

  // override global toggleConsole to respect debug flag
  const originalToggleConsole = window.toggleConsole || function(){};
  window.toggleConsole = function(){
    const dbg = localStorage.getItem('gw_debug') === '1';
    if(!dbg) return;
    originalToggleConsole();
  };

  // keydown M handler - ensure it only toggles when debug enabled
  document.addEventListener('keydown', function(e){
    if(e.key && e.key.toLowerCase() === 'm'){
      const dbg = localStorage.getItem('gw_debug') === '1';
      if(!dbg) return;
      toggleConsole();
    }
  });

  // Ping implementation: measure RTT using socket-client ping/pong messages.
  let pingInterval = null;
  window._stopPingLoop = function(){ if(pingInterval) clearInterval(pingInterval); pingInterval = null; };
  function startPingLoop(){
    if(pingInterval) clearInterval(pingInterval);
    if(!localStorage.getItem('gw_ping') || localStorage.getItem('gw_ping') !== '1') return;
    pingInterval = setInterval(()=>{
      if(window.socketClient && window.socketClient._sendPing){
        const ts = Date.now();
        window.socketClient._sendPing(ts);
      } else {
        // can't ping (no server), hide ping
        pingDisplay.style.display = 'none';
      }
    }, 1500);
  }
  // start immediately if enabled
  if(localStorage.getItem('gw_ping') === '1') startPingLoop();

  // expose a function to update ping value when pong received
  window._updatePingValue = function(ms){
    if(pingValue) pingValue.textContent = Math.max(0,Math.round(ms));
    if(pingDisplay) pingDisplay.style.display = (localStorage.getItem('gw_ping') === '1') ? 'block' : 'none';
  };

  // Hide settings if clicked outside card
  settingsModal.addEventListener('click', (ev)=>{
    if(ev.target === settingsModal) settingsModal.style.display = 'none';
  });

})();
\n</body>
</html>
