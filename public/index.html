<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Territorial â€” Socket Multiplayer</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#0d1117;font-family:Tahoma,Arial,sans-serif}
canvas{display:block;touch-action:none}

/* Lobby */
#lobby{position:fixed;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0d1117,#111827,#1a2333);animation:bgMove 8s infinite alternate}
@keyframes bgMove{0%{filter:brightness(1)}100%{filter:brightness(1.12)}}
.card{background:rgba(6,10,18,0.7);backdrop-filter:blur(8px);padding:24px;border-radius:14px;width:360px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04);color:#e6eef8}
.card h1{margin:0 0 12px;font-size:20px;text-align:center}
#telegramTag{font-size:20px;font-weight:700;color:#ff3333;text-align:center;margin-bottom:10px;text-shadow:0 0 8px rgba(255,0,0,0.12),0 0 18px rgba(255,0,0,0.06)}
label{display:block;color:#aeb9c8;margin-top:10px}
select,input[type=range]{width:100%;margin:8px 0;padding:10px;border-radius:10px;border:none;background:#101521;color:#fff}
button{padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.green{background:#16a34a;color:white}
#ratioBar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(255,255,255,0.92);padding:10px 12px;border-radius:14px;display:flex;align-items:center;gap:12px;z-index:1800}
#ratioBar input{width:160px}
#legend{position:fixed;left:12px;top:12px;z-index:1800;color:white;display:flex;flex-direction:column;gap:6px}
.legend-item{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px}
#dbg{position:fixed;top:12px;right:12px;width:300px;height:200px;background:rgba(0,0,0,0.7);color:white;padding:8px;border-radius:8px;font-size:12px;overflow:auto;z-index:9999;display:block}
#dbg button{position:absolute;top:4px;right:4px;padding:2px 6px;border:none;border-radius:4px;background:red;color:white;cursor:pointer;}
#mainMenuBtn{position:fixed;right:12px;top:12px;z-index:2100;background:#2563eb;color:white;padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.3);cursor:pointer}
#victoryOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:3000}
#victoryCard{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));backdrop-filter:blur(8px);padding:28px;border-radius:16px;text-align:center;color:white;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
#victoryCard h1{margin:8px 0 6px 0;font-size:32px}
#victoryCard .crown{font-size:46px;filter:drop-shadow(0 8px 20px rgba(255,215,0,0.3))}
#victoryCard button{margin-top:12px;padding:10px 16px;border-radius:10px;border:none;cursor:pointer}
</style>
</head>
<body>

<canvas id="game"></canvas>
<canvas id="lineLayer" style="position:fixed;inset:0;pointer-events:none;z-index:1700"></canvas>

<div id="ratioBar">
Â  <span style="font-weight:700">Ø§Ù„Ù‚ÙˆØ§Øª:</span>
Â  <input id="ratioSlider" type="range" min="10" max="100" value="50">
Â  <span id="ratioValue">50%</span>
</div>

<div id="mainMenuBtn">âŸµ Ø±Ø¬ÙˆØ¹</div>

<div id="lobby">
Â  <div class="card">
Â  Â  <h1>Ù„ÙˆØ¨ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h1>
Â  Â  <div id="telegramTag">@Z_S_T_O</div>

Â  Â  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</label>
Â  Â  <select id="playerCount">
Â  Â  Â  <option value="2">2</option>
Â  Â  Â  <option value="3">3</option>
Â  Â  Â  <option value="4" selected>4</option>
Â  Â  </select>

Â  Â  <label>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)</label>
Â  Â  <input id="prodRate" type="range" min="300" max="2000" value="900">

Â  Â  <div style="margin-top:12px">
Â  Â  Â  <button id="startBtn" class="green" style="width:100%">Ø§Ø¨Ø¯Ø£</button>

Â  Â  Â  <button id="onlineBtn">Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>

Â  Â  Â  <div id="lobbyModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;padding:20px;">
Â  Â  Â  Â  <div id="lobbyBox" style="background:#111;color:#fff;border-radius:12px;padding:18px;max-width:420px;width:100%;">
Â  Â  Â  Â  Â  <h2 style="text-align:center;margin:0 0 8px 0;">Ù„ÙˆØ¨ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
Â  Â  Â  Â  Â  <input id="nicknameInput" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ali)" />
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;">
Â  Â  Â  Â  Â  Â  <button id="createRoomBtn" style="flex:1;background:#2e7d32;">Ø§Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
Â  Â  Â  Â  Â  Â  <button id="joinRoomBtn" style="flex:1;background:#455a64;">Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ©</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <input id="roomIdInput" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© (Room ID)" />
Â  Â  Â  Â  Â  <div id="playersList" style="max-height:160px;overflow:auto;margin:8px 0;padding:6px;background:#071018;border-radius:6px;"></div>
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px;">
Â  Â  Â  Â  Â  Â  <button id="startGameBtn" style="flex:1;" disabled>Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (ÙÙ‚Ø· Ø§Ù„Ù‡ÙˆØ³Øª)</button>
Â  Â  Â  Â  Â  Â  <button id="leaveBtn" style="flex:1;display:none;">Ø§Ù„Ø®Ø±ÙˆØ¬</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="margin-top:8px;font-size:12px;color:#ccc;">Ù‚ÙˆØ§Ø¹Ø¯: Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ†. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©: 2</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  </div>
Â  </div>
</div>

<div id="legend"></div>
<div id="dbg">
  <button onclick="this.parentElement.style.display='none'">x</button>
</div>

<div id="victoryOverlay"><div id="victoryCard"><div class="crown">ğŸ‘‘</div><h1 id="victoryText"></h1><div id="victorName" style="font-size:20px;margin-top:6px"></div><button id="victoryToLobby" class="green">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‘ÙˆØ¨ÙŠ</button></div></div>

<script src="/socket.io/socket.io.js"></script>
<script>
(() => {
  if (!window || !document) return;

  const socket = io();

  let currentRoom = null;
  let myId = null;
  let myName = null;
  let isHost = false;
  let players = [];

  const onlineBtn = document.getElementById('onlineBtn');
  const lobbyModal = document.getElementById('lobbyModal');
  const nicknameInput = document.getElementById('nicknameInput');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const roomIdInput = document.getElementById('roomIdInput');
  const playersList = document.getElementById('playersList');
  const startGameBtn = document.getElementById('startGameBtn');
  const leaveBtn = document.getElementById('leaveBtn');
  const dbg = document.getElementById('dbg');

  function logDebug(msg){
    const p = document.createElement('div');
    p.innerText = msg;
    dbg.appendChild(p);
    dbg.scrollTop = dbg.scrollHeight;
    console.log(msg);
  }

  function randomColor(){
    const colors = ['#e53935','#8e24aa','#3949ab','#00897b','#f4511e','#fb8c00','#43a047','#1e88e5'];
    return colors[Math.floor(Math.random()*colors.length)];
  }

  function openLobby(){ lobbyModal.style.display='flex'; }
  function closeLobby(){ lobbyModal.style.display='none'; }

  onlineBtn.addEventListener('click', openLobby);

  function updateUIRoomCreated(){
    leaveBtn.style.display = 'block';
    startGameBtn.style.display = 'block';
    createRoomBtn.disabled = true;
    joinRoomBtn.disabled = true;
    startGameBtn.disabled = false;
  }

  function updateUIRoomJoined(){
    leaveBtn.style.display = 'block';
    startGameBtn.style.display = 'block';
    createRoomBtn.disabled = true;
    joinRoomBtn.disabled = true;
  }

  createRoomBtn.addEventListener('click', ()=>{
    myName = (nicknameInput.value||'Guest').trim();
    if(!myName) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…');
    myId = 'p_'+Date.now()+'_'+Math.floor(Math.random()*1000);
    currentRoom = 'room_'+Math.floor(Math.random()*99999);
    isHost = true;

    socket.emit('createRoom', { roomId: currentRoom, playerId: myId, name: myName, color: randomColor() });
    roomIdInput.value = currentRoom;
    updateUIRoomCreated();
    closeLobby();
    logDebug('Ø£Ù†Ø´Ø£Øª ØºØ±ÙØ© ÙƒÙ‡ÙˆØ³Øª: ' + currentRoom);
  });

  joinRoomBtn.addEventListener('click', ()=>{
    myName = (nicknameInput.value||'Guest').trim();
    if(!myName) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…');
    const room = roomIdInput.value.trim();
    if(!room) return alert('Ø§ÙƒØªØ¨ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©');
    myId = 'p_'+Date.now()+'_'+Math.floor(Math.random()*1000);
    currentRoom = room;
    isHost = false;

    socket.emit('joinRoom', { roomId: currentRoom, playerId: myId, name: myName, color: randomColor() });
    updateUIRoomJoined();
    closeLobby();
    logDebug('Ø§Ù†Ø¶Ù…Ù…Øª Ù„ØºØ±ÙØ©: ' + currentRoom);
  });

  leaveBtn.addEventListener('click', ()=>{
    if(currentRoom && myId){
      socket.emit('leaveRoom', { roomId: currentRoom, playerId: myId });
      cleanupLocal();
      closeLobby();
      logDebug('ØºØ§Ø¯Ø±Øª Ø§Ù„ØºØ±ÙØ©');
    }
  });

  startGameBtn.addEventListener('click', ()=>{
    if(!isHost || !currentRoom) return;
    socket.emit('startGame', { roomId: currentRoom });
    logDebug('Ø£Ø±Ø³Ù„ Ø£Ù…Ø± Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©');
  });

  function renderPlayers(playersArr){
    playersList.innerHTML = '';
    playersArr.forEach(p=>{
      const div = document.createElement('div');
      div.className = 'playerItem';
      div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:12px;height:12px;background:${p.color};border-radius:50%"></div><div>${escapeHtml(p.name)}</div></div>` + (p.isHost ? '<div class="hostBadge">Host</div>' : '');
      playersList.appendChild(div);
    });
    startGameBtn.disabled = !(isHost && playersArr.length>=2);
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function cleanupLocal(){
    currentRoom = null; myId = null; myName = null; isHost = false; players = [];
    playersList.innerHTML = '';
    leaveBtn.style.display = 'none';
    startGameBtn.style.display = 'none';
    createRoomBtn.disabled = false;
    joinRoomBtn.disabled = false;
  }

  // ----- Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -----
  socket.on('updatePlayers', ({players: pls, roomId})=>{
    if(roomId === currentRoom){
      players = pls;
      renderPlayers(players);
      logDebug('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: ' + players.map(p=>p.name).join(', '));
    }
  });

  // ----- Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© -----
  socket.on('gameStarted', ({roomId, players: pls})=>{
    if(roomId !== currentRoom) return;
    players = pls;
    logDebug('Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª ÙØ¹Ù„ÙŠØ§Ù‹!');
    startMultiplayerGame();
  });

  // ----- Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø±ÙƒØ§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -----
  socket.on('playerAction', ({playerId, action})=>{
    if(!action) return;
    const ev = new CustomEvent('multiplayer_action', { detail: action });
    window.dispatchEvent(ev);
  });

  // ----- Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø±ÙƒØ§ØªÙ†Ø§ -----
  window.multiplayer = {
    sendAction: (action)=>{
      if(currentRoom && myId) socket.emit('playerAction', { roomId: currentRoom, playerId: myId, action });
    },
    getCurrentRoom: ()=>currentRoom,
    isHost: ()=>isHost,
    getMyId: ()=>myId,
    getMyName: ()=>myName
  };

  // ----- Ø¯ÙˆØ§Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© -----
  function startMultiplayerGame(){
    if(typeof initMap === 'function') initMap();
    if(typeof spawnPlayers === 'function') spawnPlayers(players);
    if(typeof startGameLoop === 'function') startGameLoop();
    logDebug('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†');
  }

})();
</script>

</body>
</html>
