<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Territorial â€” Stable Final (With Effects)</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#0d1117;font-family:Tahoma,Arial,sans-serif}
canvas{display:block;touch-action:none}
/* Lobby */
#lobby{position:fixed;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0d1117,#111827,#1a2333);animation:bgMove 8s infinite alternate}
@keyframes bgMove{0%{filter:brightness(1)}100%{filter:brightness(1.12)}}
.card{background:rgba(6,10,18,0.7);backdrop-filter:blur(8px);padding:24px;border-radius:14px;width:360px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04);color:#e6eef8}
.card h1{margin:0 0 12px;font-size:20px;text-align:center}
#telegramTag{font-size:20px;font-weight:700;color:#ff3333;text-align:center;margin-bottom:10px;text-shadow:0 0 8px rgba(255,0,0,0.12),0 0 18px rgba(255,0,0,0.06)}
label{display:block;color:#aeb9c8;margin-top:10px}
select,input[type=range]{width:100%;margin:8px 0;padding:10px;border-radius:10px;border:none;background:#101521;color:#fff}
button{padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.green{background:#16a34a;color:white}
#ratioBar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(255,255,255,0.92);padding:10px 12px;border-radius:14px;display:flex;align-items:center;gap:12px;z-index:1800}
#ratioBar input{width:160px}
#legend{position:fixed;left:12px;top:12px;z-index:1800;color:white;display:flex;flex-direction:column;gap:6px}
.legend-item{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px}
#dbg{position:fixed;right:8px;bottom:8px;z-index:2200;background:rgba(0,0,0,0.7);color:#fff;padding:8px;border-radius:8px;font-size:12px;display:none;max-width:40vw}
#mainMenuBtn{position:fixed;right:12px;top:12px;z-index:2100;background:#2563eb;color:white;padding:8px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.3);cursor:pointer}
#victoryOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:3000}
#victoryCard{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.03));backdrop-filter:blur(8px);padding:28px;border-radius:16px;text-align:center;color:white;box-shadow:0 30px 80px rgba(0,0,0,0.6)}
#victoryCard h1{margin:8px 0 6px 0;font-size:32px}
#victoryCard .crown{font-size:46px;filter:drop-shadow(0 8px 20px rgba(255,215,0,0.3))}
#victoryCard button{margin-top:12px;padding:10px 16px;border-radius:10px;border:none;cursor:pointer}
</style>
</head>
<body>

<canvas id="game"></canvas>
<canvas id="lineLayer" style="position:fixed;inset:0;pointer-events:none;z-index:1700"></canvas>

<div id="ratioBar" aria-hidden="false">
Â  <span style="font-weight:700">Ø§Ù„Ù‚ÙˆØ§Øª:</span>
Â  <input id="ratioSlider" type="range" min="10" max="100" value="50">
Â  <span id="ratioValue">50%</span>
</div>

<div id="mainMenuBtn" role="button">âŸµ Ø±Ø¬ÙˆØ¹</div>

<div id="lobby" role="dialog" aria-label="Lobby">
Â  <div class="card">
Â  Â  <h1>Ù„ÙˆØ¨ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h1>
Â  Â  <div id="telegramTag">@Z_S_T_O</div>

Â  Â  <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</label>
Â  Â  <select id="playerCount">
Â  Â  Â  <option value="2">2</option>
Â  Â  Â  <option value="3">3</option>
Â  Â  Â  <option value="4" selected>4</option>
Â  Â  </select>

Â  Â  <label>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)</label>
Â  Â  <input id="prodRate" type="range" min="300" max="2000" value="900">

Â  Â  <div style="margin-top:12px">
Â  Â  Â  <button id="startBtn" class="green" style="width:100%">Ø§Ø¨Ø¯Ø£</button>
Â  Â  </div>

Â  Â  <button id="onlineBtn">Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>

Â  Â  <div id="lobbyModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999">
Â  Â  Â  <div id="lobbyBox" style="background:#111;color:#fff;border-radius:12px;padding:18px;max-width:420px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,0.7)">
Â  Â  Â  Â  <h2 style="text-align:center;margin:0 0 8px 0;">Ù„ÙˆØ¨ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
Â  Â  Â  Â  <input id="nicknameInput" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ali)" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #333;background:#0f0f10;color:#fff" />
Â  Â  Â  Â  <div style="display:flex;gap:8px;">
Â  Â  Â  Â  Â  <button id="createRoomBtn" style="flex:1;background:#2e7d32;color:#fff;padding:10px;border-radius:8px;border:none;">Ø§Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
Â  Â  Â  Â  Â  <button id="joinRoomBtn" style="flex:1;background:#455a64;color:#fff;padding:10px;border-radius:8px;border:none;">Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ©</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input id="roomIdInput" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© (Room ID)" style="width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #333;background:#0f0f10;color:#fff" />
Â  Â  Â  Â  <div id="playersList" style="max-height:160px;overflow:auto;margin:8px 0;padding:6px;background:#071018;border-radius:6px"></div>
Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px;">
Â  Â  Â  Â  Â  <button id="startGameBtn" style="flex:1;background:#1976d2;color:#fff;border:none;" disabled>Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (ÙÙ‚Ø· Ø§Ù„Ù‡ÙˆØ³Øª)</button>
Â  Â  Â  Â  Â  <button id="leaveBtn" style="flex:1;background:#b71c1c;color:#fff;border:none;display:none">Ø§Ù„Ø®Ø±ÙˆØ¬</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="margin-top:8px;font-size:12px;color:#ccc;">Ù‚ÙˆØ§Ø¹Ø¯: Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ†. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©: 2</div>
Â  Â  Â  </div>
Â  Â  </div>

</div>

<div id="legend" aria-hidden="true"></div>
<div id="dbg" role="status"></div>

<div id="victoryOverlay"><div id="victoryCard"><div class="crown">ğŸ‘‘</div><h1 id="victoryText"></h1><div id="victorName" style="font-size:20px;margin-top:6px"></div><button id="victoryToLobby" class="green">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‘ÙˆØ¨ÙŠ</button></div></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io(); // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±

var grid = [];
var players = [];
var cam = { x:0, y:0, scale:1 };
var selected = null;
var animations = [];
var effects = [];
var prodTimer = null, botTimer = null;
var dragging = false, lastX=0,lastY=0;

const HEX = 34;
const DEFEND_RADIUS = HEX*3.2;
const gameCanvas = document.getElementById('game');
const lineCanvas = document.getElementById('lineLayer');
const ctx = gameCanvas.getContext('2d');
const lctx = lineCanvas.getContext('2d');
const dbg = document.getElementById('dbg');
const ratioSlider = document.getElementById('ratioSlider');
const ratioValue = document.getElementById('ratioValue');
const startBtn = document.getElementById('startBtn');
const playerCount = document.getElementById('playerCount');
const prodRate = document.getElementById('prodRate');
const legendEl = document.getElementById('legend');
const mainMenuBtn = document.getElementById('mainMenuBtn');
const victoryOverlay = document.getElementById('victoryOverlay');
const victoryText = document.getElementById('victoryText');
const victorName = document.getElementById('victorName');
const victoryToLobby = document.getElementById('victoryToLobby');
const onlineBtn = document.getElementById('onlineBtn');
const lobbyModal = document.getElementById('lobbyModal');
const nicknameInput = document.getElementById('nicknameInput');
const createRoomBtn = document.getElementById('createRoomBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const roomIdInput = document.getElementById('roomIdInput');
const playersList = document.getElementById('playersList');
const startGameBtn = document.getElementById('startGameBtn');
const leaveBtn = document.getElementById('leaveBtn');

let currentRoom = null;
let myId = null;
let myName = null;
let isHost = false;
let localOwnerId = null;

// ==== HELPER FUNCTIONS ====

// ... (ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† buildGrid, setupPlayers, seedCapitals, startProduction, moveTroops, render, renderPlayers, checkVictory, returnToLobby ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)

// ==== SOCKET.IO ONLINE HANDLERS ====
onlineBtn.addEventListener('click', ()=>{ lobbyModal.style.display='flex'; });

createRoomBtn.addEventListener('click', ()=>{
    myName = nicknameInput.value.trim() || 'Guest';
    myId = 'p_'+Date.now();
    currentRoom = 'room_'+Date.now();
    isHost = true;
    localOwnerId = 0;
    socket.emit('createRoom', { room: currentRoom, id: myId, name: myName });
    lobbyModal.style.display='none';
});

joinRoomBtn.addEventListener('click', ()=>{
    myName = nicknameInput.value.trim() || 'Guest';
    myId = 'p_'+Date.now();
    const room = roomIdInput.value.trim();
    if(!room) return alert('Ø§ÙƒØªØ¨ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©');
    currentRoom = room;
    socket.emit('joinRoom', { room: room, id: myId, name: myName });
    lobbyModal.style.display='none';
});

leaveBtn.addEventListener('click', ()=>{
    if(currentRoom && myId) socket.emit('leaveRoom', { room: currentRoom, id: myId });
    currentRoom = null; myId = null; isHost = false;
    lobbyModal.style.display='flex';
});

startGameBtn.addEventListener('click', ()=>{
    if(currentRoom && isHost) socket.emit('startGame', { room: currentRoom });
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
socket.on('updatePlayers', ({playersArr, hostId})=>{
    playersList.innerHTML='';
    playersArr.forEach((p,i)=>{
        const div = document.createElement('div');
        div.className='playerItem';
        div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:12px;height:12px;background:${p.color};border-radius:50%"></div><div>${p.name}</div></div>`+(p.id===hostId?'<div class="hostBadge">Host</div>':'');
        playersList.appendChild(div);
    });
    if(myId===hostId) { isHost=true; startGameBtn.disabled=false; } else { isHost=false; startGameBtn.disabled=true; }
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
socket.on('startGame', ({playersArr})=>{
    setupPlayers(playersArr.length);
    for(let i=0;i<playersArr.length;i++){ players[i].name = playersArr[i].name; players[i].color = playersArr[i].color; }
    seedCapitals();
    startProduction(prodRate.value);
    botTimer && clearInterval(botTimer); // no bots
    lobbyModal.style.display='none';
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù‚ÙˆØ§Øª Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
socket.on('moveTroops', ({from,to,ratio})=>{
    moveTroops(from,to,ratio);
});

// Ø§Ø±Ø³Ø§Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ù‚ÙˆØ§Øª Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù„Ø§Ø¹Ø¨
function sendMove(from,to,ratio){ 
    if(currentRoom) socket.emit('moveTroops', { room: currentRoom, from, to, ratio }); 
}

// ==== INPUT EVENTS ====
ratioSlider.addEventListener('input', e=> ratioValue.textContent = e.target.value + '%');

gameCanvas.addEventListener('click', e=>{
    const pos = screenToWorld(e.clientX,e.clientY);
    const idx = cellAt(pos.x,pos.y);
    if(idx==null) return;
    const cell = grid[idx];
    if(selected===null){
        if(cell.owner === localOwnerId) selected = idx;
    } else {
        if(idx!==selected && isNeighbor(selected, idx)){
            const ratio = parseInt(ratioSlider.value)/100;
            moveTroops(selected, idx, ratio);
            sendMove(selected, idx, ratio);
        }
        selected=null;
    }
    needRender = true;
});

// ==== RENDER LOOP ====
let last = performance.now();
function frame(now){
    const dt = now-last; last=now;
    updateEffectsAndAnimations(dt);
    if(needRender || animations.length>0 || effects.length>0) render();
    requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

// ==== INITIAL SETUP ====
buildGrid();
setupPlayers(4);
seedCapitals();
updateLegend();
needRender = true;
</script>

</body>
</html>
